#!/bin/zsh
set -euo pipefail
setopt KSH_ARRAYS  # 0-based array indexing (bash compatibility)

# ä½¿ã„æ–¹:
#   tproj              # ç¾åœ¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèµ·å‹•ï¼ˆæ›´æ–°ã‚ã‚Šï¼‰
#   tproj -n           # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãªã—ã§èµ·å‹•ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
#   tproj -r host      # ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆã«SSHæ¥ç¶šã—ã¦èµ·å‹•
#   tproj -n -r host   # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãªã— + ãƒªãƒ¢ãƒ¼ãƒˆ

NO_UPDATE=false
REMOTE_HOST=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -n|--no-update) NO_UPDATE=true; shift ;;
    -r|--remote)
      [[ -z "${2:-}" ]] && { echo "Error: -r requires a hostname" >&2; exit 1; }
      REMOTE_HOST="$2"; shift 2 ;;
    -*) echo "Usage: tproj [-n] [-r host]" >&2; exit 1 ;;
    *) echo "Usage: tproj [-n] [-r host]" >&2; exit 1 ;;
  esac
done

# ã‚»ãƒƒã‚·ãƒ§ãƒ³å­˜åœ¨ãƒã‚§ãƒƒã‚¯é–¢æ•°
has_claude_session() {
  local abs_path="$1"
  local encoded="${abs_path//\//-}"
  [[ -f "$HOME/.claude/projects/$encoded/sessions-index.json" ]]
}

# === YAML ãƒ‘ãƒ¼ã‚¹ & ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š ===
WORKSPACE_CONFIG="$HOME/.config/tproj/workspace.yaml"
WORKSPACE_MODE=false
PROJECTS=()

if [[ -f "$WORKSPACE_CONFIG" ]]; then
  # yq ã®å­˜åœ¨ç¢ºèª
  if ! command -v yq &>/dev/null; then
    echo "Error: yq is required for workspace mode"
    echo "Install with: brew install yq"
    exit 1
  fi

  # YAML æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
  if ! yq eval '.projects[]' "$WORKSPACE_CONFIG" &>/dev/null; then
    echo "Error: Invalid YAML syntax in $WORKSPACE_CONFIG"
    echo "Please fix the syntax or remove the file to use single-project mode"
    exit 1
  fi

  # YAML ãƒ‘ãƒ¼ã‚¹ï¼ˆzsh äº’æ›ï¼‰
  PROJECTS=()
  while IFS= read -r line; do
    PROJECTS+=("$line")
  done < <(yq eval '.projects[]' "$WORKSPACE_CONFIG" 2>/dev/null)

  # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if [[ ${#PROJECTS[@]} -eq 0 ]]; then
    echo "Error: workspace.yaml exists but contains no projects"
    exit 1
  fi

  # å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã‚’è­¦å‘Šã—ã¦ã‚¹ã‚­ãƒƒãƒ—
  VALID_PROJECTS=()
  for project in "${PROJECTS[@]}"; do
    if [[ -d "$project" ]]; then
      VALID_PROJECTS+=("$project")
    else
      echo "Warning: Skipping non-existent path: $project" >&2
    fi
  done

  PROJECTS=("${VALID_PROJECTS[@]}")

  if [[ ${#PROJECTS[@]} -eq 0 ]]; then
    echo "Error: No valid project directories found"
    exit 1
  fi

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°è­¦å‘Šï¼ˆ5ä»¥ä¸Šï¼‰
  if [[ ${#PROJECTS[@]} -gt 5 ]]; then
    echo "Warning: You have ${#PROJECTS[@]} projects configured." >&2
    echo "This may make panes very narrow. Consider using fewer projects." >&2
    read -p "Continue anyway? [y/N] " answer
    case "$answer" in
      [yY]) ;;
      *) exit 0 ;;
    esac
  fi

  WORKSPACE_MODE=true
fi

# ãƒªãƒ¢ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰éå¯¾å¿œãƒã‚§ãƒƒã‚¯
if [[ "$WORKSPACE_MODE" == "true" && -n "$REMOTE_HOST" ]]; then
  echo "Error: Remote mode (-r) is not supported in workspace mode"
  echo "Please use single-project mode or remove -r option"
  exit 1
fi

# === ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ç”¨é–¢æ•° ===

# ãƒãƒ«ãƒåˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹ç¯‰
create_workspace_layout() {
  local session="$1"
  shift
  local projects=("$@")
  local num_projects=${#projects[@]}

  # æœ€åˆã®åˆ—
  local project="${projects[0]}"
  tmux new-session -d -s "$session" -c "$project" -n dev

  # æœ€åˆã® claude ãƒšã‚¤ãƒ³ã® ID ã‚’å–å¾—
  local first_claude=$(tmux list-panes -t "$session:dev" -F '#{pane_id}' | head -1)

  # Codex ã‚’ç¸¦åˆ†å‰²
  local first_codex=$(tmux split-window -v -t "$first_claude" -c "$project" -l 30% -P -F '#{pane_id}')
  sleep 0.3

  # ã‚¿ã‚°è¨­å®š
  tmux set-option -pt "$first_claude" @role "claude-p1"
  tmux set-option -pt "$first_codex" @role "codex-p1"
  tmux set-option -pt "$first_claude" @project "$project"
  tmux set-option -pt "$first_codex" @project "$project"
  tmux set-option -pt "$first_claude" @column "1"
  tmux set-option -pt "$first_codex" @column "1"

  local prev_claude="$first_claude"

  # è¿½åŠ ã®åˆ—
  for i in $(seq 2 $num_projects); do
    local project="${projects[$((i-1))]}"

    # æ¨ªåˆ†å‰²ã§æ–°ã—ã„ Claude ä½œæˆ
    local new_claude=$(tmux split-window -h -t "$prev_claude" -c "$project" -P -F '#{pane_id}')

    # ç¸¦åˆ†å‰²ã§ Codex ä½œæˆ
    local new_codex=$(tmux split-window -v -t "$new_claude" -c "$project" -l 30% -P -F '#{pane_id}')
    sleep 0.3

    # ã‚¿ã‚°è¨­å®š
    tmux set-option -pt "$new_claude" @role "claude-p$i"
    tmux set-option -pt "$new_codex" @role "codex-p$i"
    tmux set-option -pt "$new_claude" @project "$project"
    tmux set-option -pt "$new_codex" @project "$project"
    tmux set-option -pt "$new_claude" @column "$i"
    tmux set-option -pt "$new_codex" @column "$i"

    prev_claude="$new_claude"
  done

  # åˆ—å¹…å‡ç­‰åŒ–
  tmux select-layout -t "$session:dev" tiled

  # git window
  tmux new-window -t "$session" -n git -c "${projects[0]}"
}

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ãƒ„ãƒ¼ãƒ«èµ·å‹•
start_workspace_tools() {
  local session="$1"
  local no_update="$2"
  shift 2
  local projects=("$@")

  for i in $(seq 1 ${#projects[@]}); do
    local project="${projects[$((i-1))]}"
    local claude_pane=$(tmux list-panes -t "$session:dev" -F '#{pane_id}:#{@role}' \
      | grep ":claude-p$i$" | cut -d: -f1)
    local codex_pane=$(tmux list-panes -t "$session:dev" -F '#{pane_id}:#{@role}' \
      | grep ":codex-p$i$" | cut -d: -f1)

    # Claude Code èµ·å‹•ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶šåˆ¤å®šä»˜ãï¼‰
    local claude_cmd
    if has_claude_session "$project"; then
      claude_cmd="cd \"$project\" && claude --continue"
    else
      claude_cmd="cd \"$project\" && claude"
    fi

    if [[ "$no_update" == "true" ]]; then
      tmux send-keys -t "$claude_pane" "$claude_cmd" C-m
    else
      tmux send-keys -t "$claude_pane" "npm update -g @anthropic-ai/claude-code && $claude_cmd" C-m
    fi

    sleep 0.2

    # Codex èµ·å‹•
    local codex_cmd="cd \"$project\" && codex resume --last -s danger-full-access -a never --search"
    if [[ "$no_update" == "true" ]]; then
      tmux send-keys -t "$codex_pane" "$codex_cmd" C-m
    else
      tmux send-keys -t "$codex_pane" "npm update -g @openai/codex && $codex_cmd" C-m
    fi
  done

  # æœ€åˆã® Claude ãƒšã‚¤ãƒ³ã‚’é¸æŠ
  local first_claude=$(tmux list-panes -t "$session:dev" -F '#{pane_id}:#{@role}' \
    | grep ':claude-p1$' | cut -d: -f1)
  tmux select-pane -t "$first_claude"
}

# === å˜ä¸€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå¾“æ¥ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ ===

root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
name="$(basename "$root")"

# === ã‚»ãƒƒã‚·ãƒ§ãƒ³åæ±ºå®š ===
if [[ "$WORKSPACE_MODE" == "true" ]]; then
  session="tproj-workspace"
else
  # ãƒªãƒ¢ãƒ¼ãƒˆæ™‚ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³åã«ãƒ›ã‚¹ãƒˆåã‚’ä»˜åŠ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã¨å…±å­˜å¯èƒ½ã«ï¼‰
  if [[ -n "$REMOTE_HOST" ]]; then
    safe_host="${REMOTE_HOST//\./-}"
    session="${name}@${safe_host}"
  else
    session="$name"
  fi
  # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åã«ä½¿ãˆãªã„æ–‡å­—ã‚’æ½°ã™ï¼ˆ@ã¯è¨±å¯ï¼‰
  session="${session//[^A-Za-z0-9_@-]/_}"
fi

# === ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ & ãƒ„ãƒ¼ãƒ«èµ·å‹• ===
if ! tmux has-session -t "$session" 2>/dev/null; then
  if [[ "$WORKSPACE_MODE" == "true" ]]; then
    # --- ãƒãƒ«ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ ---
    create_workspace_layout "$session" "${PROJECTS[@]}"
    start_workspace_tools "$session" "$NO_UPDATE" "${PROJECTS[@]}"

    tmux select-window -t "$session:dev"
  else
    # --- å˜ä¸€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ ---
    # "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆ"ã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã™ã‚‹ï¼ˆgitãªã‚‰rootã€ç„¡ã‘ã‚Œã°cwdï¼‰
    root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

    # 1) dev window ã‚’ä½œæˆ
    tmux new-session -d -s "$session" -c "$root" -n dev

    # 2) VSCodeã£ã½ã„3ãƒšã‚¤ãƒ³ï¼ˆå·¦ãƒ¡ã‚¤ãƒ³ / å³ä¸Šwatch / å³ä¸‹logsï¼‰
    tmux split-window -h -t "$session:dev" -c "$root"
    tmux split-window -v -t "$session:dev.2" -c "$root" -l 70%

    # splitç›´å¾Œã®PTYãƒãƒƒãƒ•ã‚¡å®‰å®šå¾…ã¡ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹æ¼ã‚Œé˜²æ­¢ï¼‰
    sleep 0.3

    # 3) ãƒšã‚¤ãƒ³ã« @role ã‚¿ã‚°ã‚’è¨­å®šï¼ˆAgent Teams å‹•çš„ãƒšã‚¤ãƒ³ç®¡ç†ç”¨ï¼‰
    tmux set-option -pt "$session:dev.1" @role "claude"
    tmux set-option -pt "$session:dev.2" @role "codex"
    tmux set-option -pt "$session:dev.3" @role "yazi"

    # 4) git windowï¼ˆå·®åˆ†ã‚„ãƒ­ã‚°ç”¨ï¼‰
    tmux new-window -t "$session" -n git -c "$root"

    # 5) ã‚³ãƒãƒ³ãƒ‰ã‚’è‡ªå‹•èµ·å‹•ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆ/ãƒ­ãƒ¼ã‚«ãƒ«ã§åˆ†å²ï¼‰
    if [[ -n "$REMOTE_HOST" ]]; then
      # --- ãƒªãƒ¢ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰: å…ˆã«SSHã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã—ã€ãƒ„ãƒ¼ãƒ«ã¯å¾Œã‹ã‚‰é€ä¿¡ ---
      # SSHã§ãƒªãƒ¢ãƒ¼ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚§ãƒ«ã«å…¥ã‚‹ï¼ˆãƒ„ãƒ¼ãƒ«çµ‚äº†å¾Œã‚‚ã‚·ã‚§ãƒ«ãŒæ®‹ã‚‹ï¼‰
      for pane in 1 2 3; do
        tmux send-keys -t "$session:dev.$pane" \
          "ssh -t $REMOTE_HOST 'cd $root && exec \$SHELL -l'" C-m
      done
      tmux send-keys -t "$session:git" \
        "ssh -t $REMOTE_HOST 'cd $root && exec \$SHELL -l'" C-m

      # SSHæ¥ç¶šå¾…ã¡
      sleep 2

      # ãƒªãƒ¢ãƒ¼ãƒˆã‚·ã‚§ãƒ«å†…ã§ãƒ„ãƒ¼ãƒ«ã‚’èµ·å‹•
      if [[ "$NO_UPDATE" == "true" ]]; then
        tmux send-keys -t "$session:dev.1" "claude" C-m
        sleep 0.1
        tmux send-keys -t "$session:dev.2" "codex resume --last -s danger-full-access -a never --search" C-m
      else
        tmux send-keys -t "$session:dev.1" "npm update -g @anthropic-ai/claude-code && claude" C-m
        sleep 0.1
        tmux send-keys -t "$session:dev.2" "npm update -g @openai/codex && codex resume --last -s danger-full-access -a never --search" C-m
      fi

      sleep 0.3
      tmux send-keys -t "$session:dev.3" "yazi" C-m
    else
      # --- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ ---
      # ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰ç„¡ã«å¿œã˜ãŸèµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã‚’æ§‹ç¯‰
      if has_claude_session "$root"; then
        claude_cmd="claude --continue"
      else
        claude_cmd="claude"
      fi

      if [[ "$NO_UPDATE" == "true" ]]; then
        tmux send-keys -t "$session:dev.1" "$claude_cmd" C-m
        sleep 0.1
        tmux send-keys -t "$session:dev.2" "codex resume --last -s danger-full-access -a never --search" C-m
      else
        tmux send-keys -t "$session:dev.1" "npm update -g @anthropic-ai/claude-code && $claude_cmd" C-m
        sleep 0.1
        tmux send-keys -t "$session:dev.2" "npm update -g @openai/codex && codex resume --last -s danger-full-access -a never --search" C-m
      fi

      sleep 0.3
      tmux send-keys -t "$session:dev.3" "yazi" C-m

      tmux send-keys -t "$session:git" "echo 'ğŸŒ¿ git (status/diff/log)'" C-m
    fi

    tmux select-window -t "$session:dev"
    tmux select-pane -t "$session:dev.1"
  fi
fi

exec tmux attach -t "$session"
