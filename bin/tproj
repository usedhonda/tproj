#!/bin/zsh
set -euo pipefail

# ä½¿ã„æ–¹:
#   tproj        # ç¾åœ¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèµ·å‹•ï¼ˆæ›´æ–°ã‚ã‚Šï¼‰
#   tproj -n     # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãªã—ã§èµ·å‹•ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰

NO_UPDATE=false
[[ "${1:-}" == "-n" || "${1:-}" == "--no-update" ]] && NO_UPDATE=true

root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
name="$(basename "$root")"

# tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åã«ä½¿ãˆãªã„æ–‡å­—ã‚’æ½°ã™
session="${name//[^A-Za-z0-9_-]/_}"

# â€œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆâ€ã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã™ã‚‹ï¼ˆgitãªã‚‰rootã€ç„¡ã‘ã‚Œã°cwdï¼‰
root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

# æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°ã‚¢ã‚¿ãƒƒãƒã€ç„¡ã‘ã‚Œã°ä½œã‚‹
if ! tmux has-session -t "$session" 2>/dev/null; then
  # 1) dev window ã‚’ä½œæˆ
  tmux new-session -d -s "$session" -c "$root" -n dev

  # 2) VSCodeã£ã½ã„3ãƒšã‚¤ãƒ³ï¼ˆå·¦ãƒ¡ã‚¤ãƒ³ / å³ä¸Šwatch / å³ä¸‹logsï¼‰
  tmux split-window -h -t "$session:dev" -c "$root"
  tmux split-window -v -t "$session:dev.2" -c "$root"

  # 3) ã‚³ãƒžãƒ³ãƒ‰ã‚’è‡ªå‹•èµ·å‹•
  if [[ "$NO_UPDATE" == "true" ]]; then
    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãªã—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç”¨ï¼‰
    tmux send-keys -t "$session:dev.1" "claude --continue" C-m
    tmux send-keys -t "$session:dev.2" "codex" C-m
    tmux send-keys -t "$session:dev.3" "yazi" C-m
  else
    # ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚ã‚Šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    tmux send-keys -t "$session:dev.1" "npm update -g @anthropic-ai/claude-code && claude --continue" C-m
    tmux send-keys -t "$session:dev.2" "npm update -g @openai/codex && codex" C-m
    tmux send-keys -t "$session:dev.3" "brew upgrade yazi 2>/dev/null; yazi" C-m
  fi

  # 4) git windowï¼ˆå·®åˆ†ã‚„ãƒ­ã‚°ç”¨ï¼‰
  tmux new-window -t "$session" -n git -c "$root"
  tmux send-keys -t "$session:git" "echo 'ðŸŒ¿ git (status/diff/log)'" C-m

  tmux select-window -t "$session:dev"
  tmux select-pane -t "$session:dev.1"
fi

exec tmux attach -t "$session"
