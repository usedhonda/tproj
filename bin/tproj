#!/bin/zsh
set -euo pipefail
setopt KSH_ARRAYS  # 0-based array indexing (bash compatibility)

# Codex ãƒã‚¤ãƒŠãƒªã«ç½²åï¼ˆmacOS ã‚³ãƒ¼ãƒ‰ç½²åå•é¡Œã®å›é¿ï¼‰
sign_codex() {
  if [[ "$(uname)" == "Darwin" ]]; then
    find /opt/homebrew/lib/node_modules/@openai/codex -type f \( -perm +111 -o -name "*.node" \) -exec codesign -s - -f {} \; 2>/dev/null || true
  fi
}

# ä½¿ã„æ–¹:
#   tproj              # ç¾åœ¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèµ·å‹•
#   tproj -s           # å˜ä¸€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰å¼·åˆ¶ï¼ˆworkspace.yaml ç„¡è¦–ï¼‰
#   tproj -r host      # ãƒªãƒ¢ãƒ¼ãƒˆãƒ›ã‚¹ãƒˆã«SSHæ¥ç¶šã—ã¦èµ·å‹•
#
# npm update ã¯è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚æ‰‹å‹•ã§æ›´æ–°ã—ã¦ãã ã•ã„:
#   npm update -g @anthropic-ai/claude-code @openai/codex

show_help() {
  cat << 'EOF'
tproj - tmux project launcher

Usage:
  tproj [OPTIONS]

Options:
  --add [ALIAS]      Add workspace column (no arg: duplicate current, with alias: from workspace.yaml)
  --check            Show workspace.yaml projects, aliases, and enabled status
  -s, --single       Force single-project mode (ignore workspace.yaml)
  -r, --remote HOST  SSH remote connection
  -h, --help         Show this help message

Note:
  npm update is NOT run automatically to avoid conflicts.
  Update manually when needed:
    npm update -g @anthropic-ai/claude-code @openai/codex

Modes:
  Single Project Mode (default)
    - 3-pane layout: Claude Code, Codex, yazi
    - Session name: <project-name>

  Multi-Project Mode (workspace)
    - Enabled when ~/.config/tproj/workspace.yaml exists
    - Multiple columns, each with Claude Code + Codex
    - Session name: tproj-workspace
    - Use -s to force single mode

Workspace Configuration:
  File: ~/.config/tproj/workspace.yaml

  Example:
    projects:
      - /path/to/project1
      - /path/to/project2
      - /path/to/project3

Key Bindings:
  Prefix + y    Toggle yazi (in active column)
  Prefix + arrows    Switch between panes/columns

Examples:
  tproj                   # Auto-detect mode (workspace or single)
  tproj --add             # Add one column in running tproj-workspace
  tproj -s                # Force single mode
  tproj -r macmini        # SSH remote connection (single mode only)

For more information, see: docs/reference/agent-teams.md
EOF
}

NO_UPDATE=true  # npm update ã¯æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ãã ã•ã„
REMOTE_HOST=""
FORCE_SINGLE_MODE=false
ADD_MODE=false
ADD_ALIAS=""
CHECK_MODE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) show_help; exit 0 ;;
    --check) CHECK_MODE=true; shift ;;
    --add)
      ADD_MODE=true; shift
      if [[ $# -gt 0 && "$1" != -* ]]; then
        ADD_ALIAS="$1"; shift
      fi
      ;;
    -n|--no-update) NO_UPDATE=true; shift ;;
    -s|--single) FORCE_SINGLE_MODE=true; shift ;;
    -r|--remote)
      [[ -z "${2:-}" ]] && { echo "Error: -r requires a hostname" >&2; exit 1; }
      REMOTE_HOST="$2"; shift 2 ;;
    -*) echo "Unknown option: $1" >&2; echo "Run 'tproj --help' for usage" >&2; exit 1 ;;
    *) echo "Unexpected argument: $1" >&2; echo "Run 'tproj --help' for usage" >&2; exit 1 ;;
  esac
done

# ã‚»ãƒƒã‚·ãƒ§ãƒ³å­˜åœ¨ãƒã‚§ãƒƒã‚¯é–¢æ•°
has_claude_session() {
  local abs_path="$1"
  local encoded="${abs_path//\//-}"
  [[ -f "$HOME/.claude/projects/$encoded/sessions-index.json" ]]
}

# ãƒšã‚¤ãƒ³ãƒ©ãƒ™ãƒ«ç”Ÿæˆ
# å½¢å¼: [host] project | CC/Codex
# å¼•æ•°: project_type project_host project_path tool_kind
build_pane_label() {
  local project_type="$1"
  local project_host="$2"
  local project_path="$3"
  local tool_kind="$4"

  local host_label="local"
  if [[ "$project_type" == "remote" ]]; then
    host_label="${project_host:-remote}"
  fi

  local project_name
  project_name="$(basename "$project_path" 2>/dev/null || true)"
  [[ -z "$project_name" || "$project_name" == "." || "$project_name" == "/" ]] && project_name="unknown"

  echo "[$host_label] $project_name | $tool_kind"
}


# æ—¢å­˜ tproj-workspace ã«å³åˆ—ã‚’è¿½åŠ 
# å¼•æ•°ãªã—: ç¾åœ¨ã®ãƒšã‚¤ãƒ³ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¤‡è£½
# å¼•æ•°ã‚ã‚Š: add_workspace_column <path> <type> <host>
add_workspace_column() {
  local explicit_path="${1:-}"
  local explicit_type="${2:-}"
  local explicit_host="${3:-}"
  local session="tproj-workspace"
  local src_pane src_project src_remote_host src_remote_path
  local src_type src_host src_path src_dir
  local parsed parsed_host parsed_path
  local max_col new_col
  local right_claude new_claude new_codex
  local claude_title codex_title claude_cmd

  if [[ -z "${TMUX:-}" ]]; then
    echo "Error: --add must be run inside tmux" >&2
    exit 1
  fi

  tmux has-session -t "$session" 2>/dev/null || {
    echo "Error: $session is not running" >&2
    exit 1
  }

  tmux list-panes -t "$session:dev" >/dev/null 2>&1 || {
    echo "Error: $session:dev not found" >&2
    exit 1
  }

  if [[ -n "$explicit_path" ]]; then
    # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¢ãƒ¼ãƒ‰: å¼•æ•°ã‚’ãã®ã¾ã¾ä½¿ç”¨
    src_type="$explicit_type"
    src_host="$explicit_host"
    src_path="$explicit_path"
    src_dir="$src_path"
    [[ "$src_type" == "remote" ]] && src_dir="/tmp"
  else
    # ç¾åœ¨ã®ãƒšã‚¤ãƒ³ã‹ã‚‰å–å¾—ï¼ˆæ—¢å­˜å‹•ä½œï¼‰
    src_pane="${TMUX_PANE:-}"
    [[ -z "$src_pane" ]] && src_pane="$(tmux display-message -p '#{pane_id}' 2>/dev/null || true)"
    [[ -z "$src_pane" ]] && {
      echo "Error: cannot detect current pane" >&2
      exit 1
    }

    src_project="$(tmux display-message -t "$src_pane" -p '#{@project}' 2>/dev/null || true)"
    src_remote_host="$(tmux display-message -t "$src_pane" -p '#{@remote_host}' 2>/dev/null || true)"
    src_remote_path="$(tmux display-message -t "$src_pane" -p '#{@remote_path}' 2>/dev/null || true)"

    if [[ "$src_project" == ssh://* ]]; then
      src_type="remote"
      parsed="${src_project#ssh://}"
      parsed_host="${parsed%%/*}"
      parsed_path="/${parsed#*/}"
      src_host="${src_remote_host:-$parsed_host}"
      src_path="${src_remote_path:-$parsed_path}"
      src_dir="/tmp"
      [[ -z "$src_host" || -z "$src_path" ]] && {
        echo "Error: failed to resolve remote host/path from current pane" >&2
        exit 1
      }
    else
      src_type="local"
      src_host=""
      src_path="$src_project"
      [[ -z "$src_path" || "$src_path" == "null" ]] && \
        src_path="$(tmux display-message -t "$src_pane" -p '#{pane_current_path}' 2>/dev/null || true)"
      [[ -z "$src_path" ]] && {
        echo "Error: failed to resolve local project path from current pane" >&2
        exit 1
      }
      src_dir="$src_path"
    fi
  fi

  max_col="$(tmux list-panes -t "$session:dev" -F '#{@column}' 2>/dev/null \
    | awk '/^[0-9]+$/ { if ($1>max) max=$1 } END { print max+0 }')"
  [[ -z "$max_col" || "$max_col" -lt 1 ]] && {
    echo "Error: no workspace columns found in $session:dev" >&2
    exit 1
  }
  new_col=$((max_col + 1))

  right_claude="$(tmux list-panes -t "$session:dev" -F '#{pane_id}:#{@role}' 2>/dev/null \
    | grep ":claude-p${max_col}$" | cut -d: -f1)"
  [[ -z "$right_claude" ]] && {
    echo "Error: rightmost claude pane (claude-p${max_col}) not found" >&2
    exit 1
  }

  new_claude="$(tmux split-window -h -t "$right_claude" -c "$src_dir" -P -F '#{pane_id}')"
  new_codex="$(tmux split-window -v -t "$new_claude" -c "$src_dir" -l 30% -P -F '#{pane_id}')"
  sleep 0.3

  tmux set-option -pt "$new_claude" @role "claude-p${new_col}"
  tmux set-option -pt "$new_codex" @role "codex-p${new_col}"
  tmux set-option -pt "$new_claude" @column "$new_col"
  tmux set-option -pt "$new_codex" @column "$new_col"

  claude_title="$(build_pane_label "$src_type" "$src_host" "$src_path" "CC")"
  codex_title="$(build_pane_label "$src_type" "$src_host" "$src_path" "Codex")"
  tmux set-option -pt "$new_claude" allow-set-title off 2>/dev/null || true
  tmux select-pane -t "$new_claude" -T "$claude_title" 2>/dev/null || true
  tmux select-pane -t "$new_codex" -T "$codex_title" 2>/dev/null || true

  if [[ "$src_type" == "remote" ]]; then
    tmux set-option -pt "$new_claude" @project "ssh://$src_host/$src_path"
    tmux set-option -pt "$new_codex" @project "ssh://$src_host/$src_path"
    tmux set-option -pt "$new_claude" @remote_host "$src_host"
    tmux set-option -pt "$new_codex" @remote_host "$src_host"
    tmux set-option -pt "$new_claude" @remote_path "$src_path"
    tmux set-option -pt "$new_codex" @remote_path "$src_path"
  else
    tmux set-option -pt "$new_claude" @project "$src_path"
    tmux set-option -pt "$new_codex" @project "$src_path"
  fi

  if [[ "$src_type" == "remote" ]]; then
    tmux send-keys -t "$new_claude" "ssh -t $src_host 'cd $src_path && exec \$SHELL -l'" C-m
    tmux send-keys -t "$new_codex" "ssh -t $src_host 'cd $src_path && exec \$SHELL -l'" C-m
    sleep 2

    if [[ "$NO_UPDATE" == "true" ]]; then
      tmux send-keys -t "$new_claude" "claude --continue || claude" C-m
      sleep 0.2
      tmux send-keys -t "$new_codex" "codex resume --last -s danger-full-access -a never --search" C-m
    else
      tmux send-keys -t "$new_claude" "npm update -g @anthropic-ai/claude-code; hash -r; claude --continue || claude" C-m
      sleep 0.2
      tmux send-keys -t "$new_codex" "npm update -g @openai/codex; ~/bin/sign-codex; hash -r; codex resume --last -s danger-full-access -a never --search" C-m
    fi
  else
    if has_claude_session "$src_path"; then
      claude_cmd="cd \"$src_path\" && claude --continue"
    else
      claude_cmd="cd \"$src_path\" && claude"
    fi

    if [[ "$NO_UPDATE" == "true" ]]; then
      tmux send-keys -t "$new_claude" "$claude_cmd" C-m
      sleep 0.2
      tmux send-keys -t "$new_codex" "cd \"$src_path\" && codex resume --last -s danger-full-access -a never --search" C-m
    else
      tmux send-keys -t "$new_claude" "npm update -g @anthropic-ai/claude-code; hash -r; $claude_cmd" C-m
      sleep 0.2
      tmux send-keys -t "$new_codex" "npm update -g @openai/codex; ~/bin/sign-codex; hash -r; cd \"$src_path\" && codex resume --last -s danger-full-access -a never --search" C-m
    fi
  fi

  tmux select-pane -t "$new_claude"
  tmux select-window -t "$session:dev"
  echo "âœ… Added workspace column $new_col: $src_path" >&2
}
# === YAML ãƒ‘ãƒ¼ã‚¹ & ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š ===
WORKSPACE_CONFIG="$HOME/.config/tproj/workspace.yaml"
WORKSPACE_MODE=false

# ã‚«ã‚¿ãƒ­ã‚°é…åˆ—ï¼ˆå…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€--add ã‚¨ã‚¤ãƒªã‚¢ã‚¹è§£æ±ºç”¨ï¼‰
declare -a CATALOG_PATHS
declare -a CATALOG_TYPES
declare -a CATALOG_HOSTS
declare -a CATALOG_ALIASES

# ã‚¢ã‚¯ãƒ†ã‚£ãƒ–é…åˆ—ï¼ˆenabled=true ã®ã¿ã€èµ·å‹•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹ç¯‰ç”¨ï¼‰
declare -a PROJECT_PATHS
declare -a PROJECT_TYPES
declare -a PROJECT_HOSTS

parse_workspace_yaml() {
  echo "ğŸ“‹ Workspace: $WORKSPACE_CONFIG" >&2

  # yq ã®å­˜åœ¨ç¢ºèª
  if ! command -v yq &>/dev/null; then
    echo "" >&2
    echo "âŒ Error: yq is not installed (required for workspace mode)" >&2
    echo "" >&2
    echo "Options:" >&2
    echo "  1. Install yq:    brew install yq" >&2
    echo "  2. Use single mode: tproj -s" >&2
    echo "  3. Remove workspace.yaml to disable workspace mode" >&2
    exit 1
  fi

  # YAML æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
  if ! yq eval '.projects[]' "$WORKSPACE_CONFIG" &>/dev/null; then
    echo "" >&2
    echo "âŒ Error: Invalid YAML syntax in $WORKSPACE_CONFIG" >&2
    echo "" >&2
    echo "Options:" >&2
    echo "  1. Fix the YAML syntax" >&2
    echo "  2. Use single mode: tproj -s" >&2
    echo "  3. Remove workspace.yaml to disable workspace mode" >&2
    exit 1
  fi

  local num_projects
  num_projects=$(yq eval '.projects | length' "$WORKSPACE_CONFIG" 2>/dev/null || echo "0")

  if [[ "$num_projects" -eq 0 ]]; then
    echo "" >&2
    echo "âŒ Error: workspace.yaml exists but contains no projects" >&2
    echo "" >&2
    echo "Example workspace.yaml:" >&2
    echo "  projects:" >&2
    echo "    - path: /path/to/project1" >&2
    echo "      type: local" >&2
    echo "    - path: ~/projects/statusline" >&2
    echo "      type: remote" >&2
    echo "      host: macmini" >&2
    exit 1
  fi

  # ç°¡æ˜“å½¢å¼ï¼ˆæ–‡å­—åˆ—ãƒªã‚¹ãƒˆï¼‰ã‹è©³ç´°å½¢å¼ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆï¼‰ã‹åˆ¤å®š
  local first_item_type
  first_item_type=$(yq eval ".projects[0] | type" "$WORKSPACE_CONFIG" 2>/dev/null)

  # NOTE: zsh ã§ã¯ path/PATH ãŒé€£å‹•ã™ã‚‹ç‰¹æ®Šå¤‰æ•°ã®ãŸã‚ proj_path ã‚’ä½¿ç”¨
  local i proj_path proj_type proj_host proj_alias proj_enabled
  for ((i=0; i<num_projects; i++)); do
    if [[ "$first_item_type" == "!!str" ]]; then
      # ç°¡æ˜“å½¢å¼: æ–‡å­—åˆ—ãƒªã‚¹ãƒˆ
      proj_path=$(yq eval ".projects[$i]" "$WORKSPACE_CONFIG")
      proj_type="local"
      proj_host=""
      proj_alias="$(basename "$proj_path")"
      proj_enabled="true"
    else
      # è©³ç´°å½¢å¼: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆ
      proj_path=$(yq eval ".projects[$i].path" "$WORKSPACE_CONFIG")
      proj_type=$(yq eval ".projects[$i].type" "$WORKSPACE_CONFIG")
      proj_host=$(yq eval ".projects[$i].host" "$WORKSPACE_CONFIG")
      proj_alias=$(yq eval ".projects[$i].alias" "$WORKSPACE_CONFIG")
      proj_enabled=$(yq eval ".projects[$i].enabled" "$WORKSPACE_CONFIG")

      # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
      [[ "$proj_type" == "null" ]] && proj_type="local"
      [[ "$proj_host" == "null" ]] && proj_host=""
      [[ "$proj_alias" == "null" ]] && proj_alias="$(basename "$proj_path")"
      [[ "$proj_enabled" == "null" ]] && proj_enabled="true"
    fi

    # ãƒ‘ã‚¹ã‚’å±•é–‹ï¼ˆ~ ã‚„ç’°å¢ƒå¤‰æ•°ï¼‰
    proj_path=$(eval echo "$proj_path")

    # åŸºæœ¬ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if [[ "$proj_type" != "local" && "$proj_type" != "remote" ]]; then
      echo "  âš ï¸  Skipping unknown type '$proj_type': $proj_path" >&2
      continue
    fi
    if [[ "$proj_type" == "remote" && -z "$proj_host" ]]; then
      echo "  âš ï¸  Skipping remote project without host: $proj_path" >&2
      continue
    fi

    # ã‚«ã‚¿ãƒ­ã‚°ã«è¿½åŠ ï¼ˆenabled å•ã‚ãšã€--add ã‚¨ã‚¤ãƒªã‚¢ã‚¹è§£æ±ºç”¨ï¼‰
    CATALOG_PATHS+=("$proj_path")
    CATALOG_TYPES+=("$proj_type")
    CATALOG_HOSTS+=("$proj_host")
    CATALOG_ALIASES+=("$proj_alias")

    # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–é…åˆ—ã«ã¯ enabled=true + å­˜åœ¨ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®ã¿
    if [[ "$proj_enabled" != "true" ]]; then
      echo "  -- [disabled] $proj_path (alias: $proj_alias)" >&2
      continue
    fi

    if [[ "$proj_type" == "local" && ! -d "$proj_path" ]]; then
      echo "  âš ï¸  Skipping non-existent: $proj_path (alias: $proj_alias)" >&2
      continue
    fi

    PROJECT_PATHS+=("$proj_path")
    PROJECT_TYPES+=("$proj_type")
    PROJECT_HOSTS+=("$proj_host")

    if [[ "$proj_type" == "remote" ]]; then
      echo "  âœ… [remote@$proj_host] $proj_path (alias: $proj_alias)" >&2
    else
      echo "  âœ… [local] $proj_path (alias: $proj_alias)" >&2
    fi
  done

  echo "" >&2
}

resolve_alias_to_project() {
  local target_alias="$1"
  local i
  for ((i=0; i<${#CATALOG_ALIASES[@]}; i++)); do
    if [[ "${CATALOG_ALIASES[$i]}" == "$target_alias" ]]; then
      RESOLVED_PATH="${CATALOG_PATHS[$i]}"
      RESOLVED_TYPE="${CATALOG_TYPES[$i]}"
      RESOLVED_HOST="${CATALOG_HOSTS[$i]}"
      return 0
    fi
  done
  return 1
}

# ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
if [[ "$FORCE_SINGLE_MODE" == "false" && -f "$WORKSPACE_CONFIG" ]]; then
  # --add <alias> / --check æ™‚ã‚‚ãƒ‘ãƒ¼ã‚¹ãŒå¿…è¦
  if [[ "$ADD_MODE" == "false" ]] || [[ -n "$ADD_ALIAS" ]] || [[ "$CHECK_MODE" == "true" ]]; then
    parse_workspace_yaml
  fi

  if [[ "$ADD_MODE" == "false" && "$CHECK_MODE" == "false" ]]; then
    if [[ ${#PROJECT_PATHS[@]} -eq 0 ]]; then
      echo "" >&2
      echo "âŒ Error: No valid project directories found" >&2
      echo "" >&2
      echo "Options:" >&2
      echo "  1. Fix project paths in $WORKSPACE_CONFIG" >&2
      echo "  2. Use single mode: tproj -s" >&2
      exit 1
    fi

    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°è­¦å‘Šï¼ˆ10è¶…ï¼‰
    if [[ ${#PROJECT_PATHS[@]} -gt 10 ]]; then
      echo "âš ï¸  Warning: ${#PROJECT_PATHS[@]} projects configured (panes may be narrow)" >&2
      printf "Continue anyway? [y/N] " >&2
      read -r answer
      case "$answer" in
        [yY]) ;;
        *)
          echo "Tip: Use 'tproj -s' for single-project mode" >&2
          exit 0
          ;;
      esac
    fi

    WORKSPACE_MODE=true
  fi
fi

# ãƒªãƒ¢ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰éå¯¾å¿œãƒã‚§ãƒƒã‚¯
if [[ "$WORKSPACE_MODE" == "true" && -n "$REMOTE_HOST" ]]; then
  echo "" >&2
  echo "âŒ Error: Remote mode (-r) is not supported in workspace mode" >&2
  echo "" >&2
  echo "Options:" >&2
  echo "  1. Use single mode: tproj -s -r $REMOTE_HOST" >&2
  echo "  2. Remove -r option for local workspace mode" >&2
  exit 1
fi

if [[ "$CHECK_MODE" == "true" ]]; then
  if [[ ! -f "$WORKSPACE_CONFIG" ]]; then
    echo "No workspace config found: $WORKSPACE_CONFIG" >&2
    echo "" >&2
    echo "Create one with:" >&2
    echo "  mkdir -p ~/.config/tproj" >&2
    echo "  cp config/workspace.yaml.example ~/.config/tproj/workspace.yaml" >&2
    exit 1
  fi

  echo "Catalog (all projects):" >&2
  for ((i=0; i<${#CATALOG_ALIASES[@]}; i++)); do
    local_type="${CATALOG_TYPES[$i]}"
    local_host="${CATALOG_HOSTS[$i]}"
    local_label="[local]"
    [[ "$local_type" == "remote" ]] && local_label="[remote@$local_host]"

    # enabled åˆ¤å®š: PROJECT_PATHS ã«å«ã¾ã‚Œã¦ã„ã‚Œã° active
    is_active=false
    for ((j=0; j<${#PROJECT_PATHS[@]}; j++)); do
      if [[ "${PROJECT_PATHS[$j]}" == "${CATALOG_PATHS[$i]}" ]]; then
        is_active=true
        break
      fi
    done

    if [[ "$is_active" == "true" ]]; then
      printf "  %-20s  %-12s  %s  %s\n" "${CATALOG_ALIASES[$i]}" "$local_label" "${CATALOG_PATHS[$i]}" "" >&2
    else
      printf "  %-20s  %-12s  %s  (disabled)\n" "${CATALOG_ALIASES[$i]}" "$local_label" "${CATALOG_PATHS[$i]}" >&2
    fi
  done

  echo "" >&2
  echo "Active: ${#PROJECT_PATHS[@]} / Catalog: ${#CATALOG_ALIASES[@]}" >&2

  if [[ ${#CATALOG_ALIASES[@]} -gt ${#PROJECT_PATHS[@]} ]]; then
    echo "" >&2
    echo "Tip: Add disabled projects with: tproj --add <alias>" >&2
  fi
  exit 0
fi

if [[ "$ADD_MODE" == "true" ]]; then
  [[ -n "$REMOTE_HOST" ]] && {
    echo "Error: --add cannot be used with -r/--remote" >&2
    exit 1
  }
  [[ "$FORCE_SINGLE_MODE" == "true" ]] && {
    echo "Error: --add cannot be used with -s/--single" >&2
    exit 1
  }
  if [[ -n "$ADD_ALIAS" ]]; then
    if resolve_alias_to_project "$ADD_ALIAS"; then
      add_workspace_column "$RESOLVED_PATH" "$RESOLVED_TYPE" "$RESOLVED_HOST"
    else
      echo "Error: Unknown alias '$ADD_ALIAS'" >&2
      echo "" >&2
      echo "Available:" >&2
      for ((i=0; i<${#CATALOG_ALIASES[@]}; i++)); do
        echo "  ${CATALOG_ALIASES[$i]}  ->  ${CATALOG_PATHS[$i]}" >&2
      done
      exit 1
    fi
  else
    add_workspace_column
  fi
  exit 0
fi

# === ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ç”¨é–¢æ•° ===

# ãƒãƒ«ãƒåˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹ç¯‰
# å¼•æ•°: session paths[@] types[@] hosts[@]
create_workspace_layout() {
  local session="$1"
  shift

  # é…åˆ—ã‚’åˆ†é›¢ï¼ˆpaths, types, hostsï¼‰
  local -a paths types hosts
  local num_projects=0

  # æœ€åˆã®é…åˆ—çµ‚äº†ã¾ã§ paths ã«æ ¼ç´
  while [[ $# -gt 0 && "$1" != "--" ]]; do
    paths+=("$1")
    ((num_projects++)) || true
    shift
  done
  shift  # "--" ã‚’ã‚¹ã‚­ãƒƒãƒ—

  # types ã‚’æ ¼ç´
  while [[ $# -gt 0 && "$1" != "--" ]]; do
    types+=("$1")
    shift
  done
  shift  # "--" ã‚’ã‚¹ã‚­ãƒƒãƒ—

  # hosts ã‚’æ ¼ç´
  while [[ $# -gt 0 ]]; do
    hosts+=("$1")
    shift
  done

  # å…¨ã¦ã® Claude ãƒšã‚¤ãƒ³ã‚’å…ˆã«æ¨ªã«ä½œæˆ
  declare -a claude_panes
  declare -a codex_panes

  # æœ€åˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å„ªå…ˆã€ãªã‘ã‚Œã° /tmpï¼‰
  local first_dir="${paths[0]}"
  if [[ "${types[0]}" == "remote" ]]; then
    first_dir="/tmp"  # ãƒªãƒ¢ãƒ¼ãƒˆã®å ´åˆã¯ä¸€æ™‚çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  fi

  tmux new-session -d -s "$session" -c "$first_dir" -n dev
  tmux set-option -t "$session" @tproj true

  local first_codex=$(tmux list-panes -t "$session:dev" -F '#{pane_id}' | head -1)
  codex_panes[0]="$first_codex"

  # è¿½åŠ ã® Codex ãƒšã‚¤ãƒ³ã‚’æ¨ªã«ä½œæˆ
  local prev_codex="$first_codex"
  for i in $(seq 2 $num_projects); do
    local proj_path="${paths[$((i-1))]}"
    local proj_type="${types[$((i-1))]}"
    local dir="$proj_path"
    [[ "$proj_type" == "remote" ]] && dir="/tmp"

    local new_codex=$(tmux split-window -h -t "$prev_codex" -c "$dir" -P -F '#{pane_id}')
    if [[ -z "$new_codex" ]]; then
      echo "Error: failed to create column $i (window may be too narrow for $num_projects columns)" >&2
      num_projects=$((i - 1))
      break
    fi
    codex_panes[$((i-1))]="$new_codex"
    prev_codex="$new_codex"

    # å‡ç­‰åŒ–ã—ã¦æ¬¡ã®åˆ†å‰²ã«ååˆ†ãªå¹…ã‚’ç¢ºä¿
    tmux select-layout -t "$session:dev" even-horizontal 2>/dev/null || true
  done

  sleep 0.3

  # å„ Codex ã®ä¸‹ã« Claude ã‚’ä½œæˆ
  for i in $(seq 1 $num_projects); do
    local proj_path="${paths[$((i-1))]}"
    local proj_type="${types[$((i-1))]}"
    local proj_host="${hosts[$((i-1))]}"
    local dir="$proj_path"
    [[ "$proj_type" == "remote" ]] && dir="/tmp"

    local codex_pane="${codex_panes[$((i-1))]}"
    local claude_pane=$(tmux split-window -v -t "$codex_pane" -c "$dir" -l 70% -P -F '#{pane_id}')
    claude_panes[$((i-1))]="$claude_pane"

    # ã‚¿ã‚°è¨­å®š
    tmux set-option -pt "$codex_pane" @role "codex-p$i"
    tmux set-option -pt "$claude_pane" @role "claude-p$i"
    tmux set-option -pt "$codex_pane" @column "$i"
    tmux set-option -pt "$claude_pane" @column "$i"

    # ãƒšã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
    local codex_title claude_title
    codex_title="$(build_pane_label "$proj_type" "$proj_host" "$proj_path" "Codex")"
    claude_title="$(build_pane_label "$proj_type" "$proj_host" "$proj_path" "CC")"
    # Claude ãŒ OSC ã‚¿ã‚¤ãƒˆãƒ«ã§ pane_title ã‚’ä¸Šæ›¸ãã™ã‚‹ãŸã‚å›ºå®šåŒ–
    tmux set-option -pt "$claude_pane" allow-set-title off 2>/dev/null || true
    tmux select-pane -t "$codex_pane" -T "$codex_title" 2>/dev/null || true
    tmux select-pane -t "$claude_pane" -T "$claude_title" 2>/dev/null || true

    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã®ã‚¿ã‚°è¨­å®š
    if [[ "$proj_type" == "remote" ]]; then
      tmux set-option -pt "$codex_pane" @project "ssh://$proj_host/$proj_path"
      tmux set-option -pt "$claude_pane" @project "ssh://$proj_host/$proj_path"
      tmux set-option -pt "$codex_pane" @remote_host "$proj_host"
      tmux set-option -pt "$claude_pane" @remote_host "$proj_host"
      tmux set-option -pt "$codex_pane" @remote_path "$proj_path"
      tmux set-option -pt "$claude_pane" @remote_path "$proj_path"
    else
      tmux set-option -pt "$codex_pane" @project "$proj_path"
      tmux set-option -pt "$claude_pane" @project "$proj_path"
    fi

    sleep 0.2
  done

  # åˆ—å¹…ã‚’å‡ç­‰åŒ–
  local window_width=$(tmux display-message -t "$session:dev" -p '#{window_width}')
  local column_width=$((window_width / num_projects))

  for i in $(seq 0 $((num_projects - 1))); do
    local codex_pane="${codex_panes[$i]}"
    [[ -z "$codex_pane" ]] && continue
    tmux resize-pane -t "$codex_pane" -x "$column_width" 2>/dev/null || true
  done

  # git windowï¼ˆæœ€åˆã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ãªã‘ã‚Œã° /tmpï¼‰
  local git_dir="/tmp"
  for i in $(seq 0 $((num_projects - 1))); do
    if [[ "${types[$i]}" == "local" ]]; then
      git_dir="${paths[$i]}"
      break
    fi
  done
  tmux new-window -t "$session" -n git -c "$git_dir"
}

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ãƒ„ãƒ¼ãƒ«èµ·å‹•
# å¼•æ•°: session no_update paths[@] types[@] hosts[@]
start_workspace_tools() {
  local session="$1"
  local no_update="$2"
  shift 2

  # é…åˆ—ã‚’åˆ†é›¢ï¼ˆpaths, types, hostsï¼‰
  local -a paths types hosts
  local num_projects=0

  # æœ€åˆã®é…åˆ—çµ‚äº†ã¾ã§ paths ã«æ ¼ç´
  while [[ $# -gt 0 && "$1" != "--" ]]; do
    paths+=("$1")
    ((num_projects++)) || true
    shift
  done
  shift  # "--" ã‚’ã‚¹ã‚­ãƒƒãƒ—

  # types ã‚’æ ¼ç´
  while [[ $# -gt 0 && "$1" != "--" ]]; do
    types+=("$1")
    shift
  done
  shift  # "--" ã‚’ã‚¹ã‚­ãƒƒãƒ—

  # hosts ã‚’æ ¼ç´
  while [[ $# -gt 0 ]]; do
    hosts+=("$1")
    shift
  done

  for i in $(seq 1 $num_projects); do
    local proj_path="${paths[$((i-1))]}"
    local proj_type="${types[$((i-1))]}"
    local proj_host="${hosts[$((i-1))]}"

    # ãƒšã‚¤ãƒ³ ID å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
    local claude_pane=$(tmux list-panes -t "$session:dev" -F '#{pane_id}:#{@role}' \
      | grep ":claude-p$i$" | cut -d: -f1)
    local codex_pane=$(tmux list-panes -t "$session:dev" -F '#{pane_id}:#{@role}' \
      | grep ":codex-p$i$" | cut -d: -f1)

    if [[ -z "$claude_pane" ]]; then
      echo "Error: Cannot find claude-p$i pane for proj_path: $proj_path" >&2
      echo "Available panes:" >&2
      tmux list-panes -t "$session:dev" -F '#{pane_id}:#{@role}' >&2
      continue
    fi

    if [[ -z "$codex_pane" ]]; then
      echo "Error: Cannot find codex-p$i pane for proj_path: $proj_path" >&2
      echo "Available panes:" >&2
      tmux list-panes -t "$session:dev" -F '#{pane_id}:#{@role}' >&2
      continue
    fi

    if [[ "$proj_type" == "remote" ]]; then
      # --- ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ---
      # SSH æ¥ç¶šã—ã¦ãƒªãƒ¢ãƒ¼ãƒˆãƒ‘ã‚¹ã«ç§»å‹•
      tmux send-keys -t "$claude_pane" \
        "ssh -t $proj_host 'cd $proj_path && exec \$SHELL -l'" C-m
      tmux send-keys -t "$codex_pane" \
        "ssh -t $proj_host 'cd $proj_path && exec \$SHELL -l'" C-m

      # SSH æ¥ç¶šå¾…ã¡
      sleep 2

      # ãƒªãƒ¢ãƒ¼ãƒˆã‚·ã‚§ãƒ«å†…ã§ãƒ„ãƒ¼ãƒ«ã‚’èµ·å‹•
      if [[ "$no_update" == "true" ]]; then
        tmux send-keys -t "$claude_pane" "claude --continue || claude" C-m
        sleep 0.2
        tmux send-keys -t "$codex_pane" "codex resume --last -s danger-full-access -a never --search" C-m
      else
        tmux send-keys -t "$claude_pane" "npm update -g @anthropic-ai/claude-code; hash -r; claude --continue || claude" C-m
        sleep 0.2
        tmux send-keys -t "$codex_pane" "npm update -g @openai/codex; ~/bin/sign-codex; hash -r; codex resume --last -s danger-full-access -a never --search" C-m
      fi
    else
      # --- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ---
      # Claude Code èµ·å‹•ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶šåˆ¤å®šä»˜ãï¼‰
      local claude_cmd
      if has_claude_session "$proj_path"; then
        claude_cmd="cd \"$proj_path\" && claude --continue"
      else
        claude_cmd="cd \"$proj_path\" && claude"
      fi

      if [[ "$no_update" == "true" ]]; then
        tmux send-keys -t "$claude_pane" "$claude_cmd" C-m
      else
        tmux send-keys -t "$claude_pane" "npm update -g @anthropic-ai/claude-code; $claude_cmd" C-m
      fi

      sleep 0.2

      # Codex èµ·å‹•
      local codex_cmd="cd \"$proj_path\" && codex resume --last -s danger-full-access -a never --search"
      if [[ "$no_update" == "true" ]]; then
        tmux send-keys -t "$codex_pane" "$codex_cmd" C-m
      else
        tmux send-keys -t "$codex_pane" "npm update -g @openai/codex; ~/bin/sign-codex; hash -r; $codex_cmd" C-m
      fi
    fi
  done

  # æœ€åˆã® Claude ãƒšã‚¤ãƒ³ã‚’é¸æŠ
  local first_claude=$(tmux list-panes -t "$session:dev" -F '#{pane_id}:#{@role}' \
    | grep ':claude-p1$' | cut -d: -f1)

  if [[ -n "$first_claude" ]]; then
    tmux select-pane -t "$first_claude"
  fi
}

# === å˜ä¸€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå¾“æ¥ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ ===

root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
name="$(basename "$root")"

# === ã‚»ãƒƒã‚·ãƒ§ãƒ³åæ±ºå®š ===
if [[ "$WORKSPACE_MODE" == "true" ]]; then
  session="tproj-workspace"
else
  # ãƒªãƒ¢ãƒ¼ãƒˆæ™‚ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³åã«ãƒ›ã‚¹ãƒˆåã‚’ä»˜åŠ ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã¨å…±å­˜å¯èƒ½ã«ï¼‰
  if [[ -n "$REMOTE_HOST" ]]; then
    safe_host="${REMOTE_HOST//\./-}"
    session="${name}@${safe_host}"
  else
    session="$name"
  fi
  # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åã«ä½¿ãˆãªã„æ–‡å­—ã‚’æ½°ã™ï¼ˆ@ã¯è¨±å¯ï¼‰
  session="${session//[^A-Za-z0-9_@-]/_}"
fi

# === tproj é–¢é€£ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¸€æƒ ===
tmux list-sessions -F '#{session_name} #{@tproj}' 2>/dev/null | while read sname tag; do
  if [[ "$tag" == "true" ]]; then
    tmux kill-session -t "$sname" 2>/dev/null || true
  fi
done

# === ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ & ãƒ„ãƒ¼ãƒ«èµ·å‹• ===
if [[ "$WORKSPACE_MODE" == "true" ]]; then
    # --- ãƒãƒ«ãƒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ ---
    create_workspace_layout "$session" "${PROJECT_PATHS[@]}" -- "${PROJECT_TYPES[@]}" -- "${PROJECT_HOSTS[@]}"
    start_workspace_tools "$session" "$NO_UPDATE" "${PROJECT_PATHS[@]}" -- "${PROJECT_TYPES[@]}" -- "${PROJECT_HOSTS[@]}"

    tmux select-window -t "$session:dev"
  else
    # --- å˜ä¸€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰ ---
    # "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆ"ã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã™ã‚‹ï¼ˆgitãªã‚‰rootã€ç„¡ã‘ã‚Œã°cwdï¼‰
    root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"

    # 1) dev window ã‚’ä½œæˆ
    tmux new-session -d -s "$session" -c "$root" -n dev
    tmux set-option -t "$session" @tproj true

    # 2) VSCodeã£ã½ã„3ãƒšã‚¤ãƒ³ï¼ˆå·¦ãƒ¡ã‚¤ãƒ³ / å³ä¸Šwatch / å³ä¸‹logsï¼‰
    tmux split-window -h -t "$session:dev" -c "$root"
    tmux split-window -v -t "$session:dev.2" -c "$root" -l 70%

    # splitç›´å¾Œã®PTYãƒãƒƒãƒ•ã‚¡å®‰å®šå¾…ã¡ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹æ¼ã‚Œé˜²æ­¢ï¼‰
    sleep 0.3

    # 3) ãƒšã‚¤ãƒ³ã« @role ã‚¿ã‚°ã‚’è¨­å®šï¼ˆAgent Teams å‹•çš„ãƒšã‚¤ãƒ³ç®¡ç†ç”¨ï¼‰
    tmux set-option -pt "$session:dev.1" @role "claude"
    tmux set-option -pt "$session:dev.2" @role "codex"
    tmux set-option -pt "$session:dev.3" @role "yazi"

    # 3.1) ãƒšã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«è¨­å®šï¼ˆClaude/Codexã®ã¿ï¼‰
    title_host="local"
    [[ -n "$REMOTE_HOST" ]] && title_host="$REMOTE_HOST"
    claude_title=""
    codex_title=""
    claude_title="$(build_pane_label "${REMOTE_HOST:+remote}" "$title_host" "$root" "CC")"
    codex_title="$(build_pane_label "${REMOTE_HOST:+remote}" "$title_host" "$root" "Codex")"
    # å˜ä¸€ãƒ¢ãƒ¼ãƒ‰ã® Claude ã§ã‚‚ã‚¿ã‚¤ãƒˆãƒ«ä¸Šæ›¸ãã‚’æŠ‘æ­¢
    tmux set-option -pt "$session:dev.1" allow-set-title off 2>/dev/null || true
    tmux select-pane -t "$session:dev.1" -T "$claude_title" 2>/dev/null || true
    tmux select-pane -t "$session:dev.2" -T "$codex_title" 2>/dev/null || true

    # 4) git windowï¼ˆå·®åˆ†ã‚„ãƒ­ã‚°ç”¨ï¼‰
    tmux new-window -t "$session" -n git -c "$root"

    # 5) ã‚³ãƒãƒ³ãƒ‰ã‚’è‡ªå‹•èµ·å‹•ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆ/ãƒ­ãƒ¼ã‚«ãƒ«ã§åˆ†å²ï¼‰
    if [[ -n "$REMOTE_HOST" ]]; then
      # --- ãƒªãƒ¢ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰: å…ˆã«SSHã‚·ã‚§ãƒ«ã‚’èµ·å‹•ã—ã€ãƒ„ãƒ¼ãƒ«ã¯å¾Œã‹ã‚‰é€ä¿¡ ---
      # SSHã§ãƒªãƒ¢ãƒ¼ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚§ãƒ«ã«å…¥ã‚‹ï¼ˆãƒ„ãƒ¼ãƒ«çµ‚äº†å¾Œã‚‚ã‚·ã‚§ãƒ«ãŒæ®‹ã‚‹ï¼‰
      for pane in 1 2 3; do
        tmux send-keys -t "$session:dev.$pane" \
          "ssh -t $REMOTE_HOST 'cd $root && exec \$SHELL -l'" C-m
      done
      tmux send-keys -t "$session:git" \
        "ssh -t $REMOTE_HOST 'cd $root && exec \$SHELL -l'" C-m

      # SSHæ¥ç¶šå¾…ã¡
      sleep 2

      # ãƒªãƒ¢ãƒ¼ãƒˆã‚·ã‚§ãƒ«å†…ã§ãƒ„ãƒ¼ãƒ«ã‚’èµ·å‹•
      if [[ "$NO_UPDATE" == "true" ]]; then
        tmux send-keys -t "$session:dev.1" "claude --continue || claude" C-m
        sleep 0.1
        tmux send-keys -t "$session:dev.2" "codex resume --last -s danger-full-access -a never --search" C-m
      else
        tmux send-keys -t "$session:dev.1" "npm update -g @anthropic-ai/claude-code; hash -r; claude --continue || claude" C-m
        sleep 0.1
        tmux send-keys -t "$session:dev.2" "npm update -g @openai/codex; ~/bin/sign-codex; hash -r; codex resume --last -s danger-full-access -a never --search" C-m
      fi

      sleep 0.3
      tmux send-keys -t "$session:dev.3" "yazi" C-m
    else
      # --- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ ---
      # ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰ç„¡ã«å¿œã˜ãŸèµ·å‹•ã‚³ãƒãƒ³ãƒ‰ã‚’æ§‹ç¯‰
      if has_claude_session "$root"; then
        claude_cmd="claude --continue"
      else
        claude_cmd="claude"
      fi

      if [[ "$NO_UPDATE" == "true" ]]; then
        tmux send-keys -t "$session:dev.1" "$claude_cmd" C-m
        sleep 0.1
        tmux send-keys -t "$session:dev.2" "codex resume --last -s danger-full-access -a never --search" C-m
      else
        tmux send-keys -t "$session:dev.1" "npm update -g @anthropic-ai/claude-code; hash -r; $claude_cmd" C-m
        sleep 0.1
        tmux send-keys -t "$session:dev.2" "npm update -g @openai/codex; ~/bin/sign-codex; hash -r; codex resume --last -s danger-full-access -a never --search" C-m
      fi

      sleep 0.3
      tmux send-keys -t "$session:dev.3" "yazi" C-m

      tmux send-keys -t "$session:git" "echo 'ğŸŒ¿ git (status/diff/log)'" C-m
    fi

    tmux select-window -t "$session:dev"
    tmux select-pane -t "$session:dev.1"
fi

exec tmux attach -t "$session"
